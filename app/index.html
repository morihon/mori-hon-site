<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>問題出題（仮：入力・採点・保存＋タグ/履歴）｜学びの森</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; padding: 40px; background:#f8fafc; }
    .wrap { max-width: 820px; margin: 0 auto; background: #fff; border:1px solid #e5e7eb; border-radius:12px; padding:24px; }
    h1 { margin: 0 0 12px; font-size: 24px; }
    p  { color:#374151; }
    .back a { text-decoration:none; color:#2563eb; font-weight:600; }
    .box { background:#f1f5f9; border-radius:8px; padding:12px 14px; margin:14px 0; }
    .row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; padding:10px 0; border-bottom:1px dashed #e5e7eb; }
    .row:last-child{border-bottom:0}
    input.answer { width: 160px; padding: 8px 10px; border:1px solid #cbd5e1; border-radius:8px; font-size:16px; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; }
    .btn { appearance:none; border:1px solid #cbd5e1; background:#fff; padding:10px 14px; border-radius:8px; }
    .btn.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #cbd5e1; color:#374151; background:#fff; }
    .pill.ok { border-color:#16a34a; color:#166534; background:#ecfdf5; }
    .pill.ng { border-color:#dc2626; color:#991b1b; background:#fef2f2; }
    .muted { color:#6b7280; font-size:14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>問題出題（仮：入力・採点・保存）</h1>
    <div id="info" class="box">読み込み中...</div>

    <div class="controls">
      <button id="gen" class="btn">新しい問題を生成</button>
      <button id="gradeBtn" class="btn primary">採点する</button>
      <button id="print" class="btn">PDFにする（印刷）</button>
      <button id="reset" class="btn">リセット</button>
      <span id="saveStatus" class="muted">未保存</span>
    </div>

    <div id="problems" class="box"></div>

    <p class="muted">※ データはこの端末のブラウザ内（localStorage）に保存されます。再読み込みや誤操作でも回答は消えません。</p>
    <div class="back" style="margin-top:10px;"><a href="/">← 学年を選び直す</a></div>
  </div>

  <script>
    // ===== 基本情報（タグをここで定義） =====
    const params = new URLSearchParams(location.search);
    const grade = params.get('grade') || '(未指定)';
    const unit  = params.get('unit')  || 'all';
    const unitLabelMap = { calc:'計算', word:'文章題', geometry:'図形', all:'指定なし' };
    const gradeLabel = `小${grade}`;
    const unitLabel  = unitLabelMap[unit] || unit;

    // 保存キーをv2に（将来の互換対策）
    const stateKey   = `mnm_state:v2:grade=${grade}:unit=${unit}`;

    document.getElementById('info').textContent =
      `選択：学年＝${gradeLabel}／単元＝${unitLabel}`;

    // ===== 乱数ユーティリティ =====
    const rnd = (min, max) => Math.floor(Math.random()*(max-min+1))+min;

    // ===== 問題テンプレ（仮）: {text, answer, tags[]} を返す =====
    const pool = {
      calc: [
        g => {
          const a = 45, b = 10*g, c = g;
          return { text:`${a}＋${b}−${c} を計算しなさい。`,
                   answer:(a+b-c).toString(),
                   tags:[`学年:${g}`, '単元:計算', '種別:加減混合'] };
        },
        g => {
          const a = g*3, b = 7;
          return { text:`${a}×${b} を計算しなさい。`,
                   answer:(a*b).toString(),
                   tags:[`学年:${g}`, '単元:計算', '種別:乗算'] };
        },
        g => {
          const a = g*12, b = 3;
          return { text:`${a}÷${b} の商を求めなさい。`,
                   answer:(a/b).toString(),
                   tags:[`学年:${g}`, '単元:計算', '種別:除算'] };
        },
      ],
      word: [
        g => {
          const each = g+2, total = each*3;
          const bags = Math.ceil(total/each);
          return { text:`りんごを${each}個ずつ袋に入れます。全部で${total}個あるとき、袋はいくつ必要ですか。`,
                   answer:bags.toString(),
                   tags:[`学年:${g}`, '単元:文章題', '場面:個数/等分'] };
        },
        g => {
          const per = g+1, days = g+3, pages = per*days;
          return { text:`Aさんは毎日${per}ページ読書します。${days}日で何ページ読めますか。`,
                   answer:pages.toString(),
                   tags:[`学年:${g}`, '単元:文章題', '場面:日数×ページ'] };
        },
      ],
      geometry: [
        g => {
          const side = g+3;
          return { text:`一辺${side}cmの正方形の周の長さを求めなさい。`,
                   answer:(side*4).toString(),
                   tags:[`学年:${g}`, '単元:図形', '図形:正方形', '概念:周'] };
        },
        g => {
          const h = g+2, w = g+4;
          return { text:`縦${h}cm・横${w}cmの長方形の面積を求めなさい。`,
                   answer:(h*w).toString(),
                   tags:[`学年:${g}`, '単元:図形', '図形:長方形', '概念:面積'] };
        },
      ],
    };

    // 問題セット生成（タグと一意IDを付与）
    function makeProblemSet(g, u, count=5) {
      const base = pool[u] || [...pool.calc, ...pool.word, ...pool.geometry];
      const out = [];
      for (let i=0;i<count;i++){
        const f = base[rnd(0, base.length-1)];
        const {text, answer, tags} = f(g);
        out.push({
          id:`q${Date.now()}_${i}_${Math.random().toString(36).slice(2,6)}`,
          text, answer,
          tags,               // ここで問題タグを保存
          userAnswer:'',      // ユーザー入力
          result:null,        // true/false/null
          lastAttemptAt:null  // 最後に採点した時刻（ms）
        });
      }
      return out;
    }

    // ===== 状態（履歴logも別テーブル的に保持） =====
    let state = {
      meta: {
        grade, unit,
        gradeLabel, unitLabel,
        createdAt: Date.now(),
        tags: [ `学年:${grade}`, `単元:${unitLabel}` ]  // セット全体のタグ
      },
      problems: [],  // {id, text, answer, tags[], userAnswer, result, lastAttemptAt}
      log: []        // [{problemId, correct, at, tags[]}]
    };

    function save() {
      localStorage.setItem(stateKey, JSON.stringify(state));
      document.getElementById('saveStatus').textContent = '保存済み';
    }
    function load() {
      const raw = localStorage.getItem(stateKey);
      if (!raw) return false;
      try {
        const s = JSON.parse(raw);
        if (s?.meta?.grade === grade && s?.meta?.unit === unit && Array.isArray(s.problems)) {
          // v1→v2 互換のためのフォールバック
          s.log = Array.isArray(s.log) ? s.log : [];
          s.meta.tags = Array.isArray(s.meta.tags) ? s.meta.tags : [ `学年:${grade}`, `単元:${unitLabel}` ];
          s.problems.forEach(p => {
            if (!Array.isArray(p.tags)) p.tags = [`学年:${grade}`, `単元:${unitLabel}`];
            if (!('lastAttemptAt' in p)) p.lastAttemptAt = null;
          });
          state = s;
          return true;
        }
      } catch(_) {}
      return false;
    }
    function clearState() {
      localStorage.removeItem(stateKey);
    }

    // ===== 描画 =====
    const problemsEl = document.getElementById('problems');
    function render() {
      if (!state.problems.length) {
        problemsEl.innerHTML = `<p class="muted">「新しい問題を生成」を押すと、この学年・単元で5題を作ります。</p>`;
        return;
      }
      problemsEl.innerHTML = state.problems.map((p, idx) => {
        const mark = p.result === true ? '<span class="pill ok">○ 正解</span>'
                  : p.result === false ? '<span class="pill ng">× 不正解</span>'
                  : '<span class="pill">未採点</span>';
        const t = p.lastAttemptAt ? new Date(p.lastAttemptAt).toLocaleString() : '—';
        return `
          <div class="row" data-id="${p.id}">
            <div>
              <div><strong>Q${idx+1}.</strong> ${p.text}</div>
              <div class="muted">（答え：整数で入力） ｜ タグ: ${p.tags.join(' / ')} ｜ 最終採点: ${t}</div>
            </div>
            <div>
              <input class="answer" inputmode="numeric" pattern="[0-9\\-]+" placeholder="答え" value="${p.userAnswer ?? ''}">
              <div style="text-align:right;margin-top:6px;">${mark}</div>
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('saveStatus').textContent = '保存済み';
    }

    // 入力のオートセーブ
    problemsEl.addEventListener('input', (e) => {
      const row = e.target.closest('.row');
      if (!row) return;
      const id = row.getAttribute('data-id');
      const prob = state.problems.find(x => x.id === id);
      if (!prob) return;
      prob.userAnswer = e.target.value.trim();
      document.getElementById('saveStatus').textContent = '保存中…';
      if (save._t) clearTimeout(save._t);
      save._t = setTimeout(save, 300);
    });

    // ===== 採点（attemptAt と log 追加） =====
    function gradeAll() {
      let correct = 0;
      const now = Date.now();
      state.problems.forEach(p => {
        const ua = (p.userAnswer ?? '').trim();
        p.result = (ua !== '' && ua === p.answer);
        p.lastAttemptAt = now;
        state.log.push({
          problemId: p.id,
          correct: p.result,
          at: now,
          tags: p.tags.slice() // 問題のタグを記録
        });
        if (p.result) correct++;
      });
      save();
      render();
      alert(`採点完了：${correct} / ${state.problems.length} 正解`);
    }

    // ===== 初期化 =====
    const has = load();
    if (!has) render(); else render();

    // ===== ボタン操作 =====
    document.getElementById('gen').addEventListener('click', () => {
      if (state.problems.length > 0) {
        const ok = confirm('現在の問題と入力は上書きされます。新しい問題を作りますか？');
        if (!ok) return;
      }
      state = {
        meta:{ grade, unit, gradeLabel, unitLabel, createdAt: Date.now(), tags:[ `学年:${grade}`, `単元:${unitLabel}` ] },
        problems: makeProblemSet(grade, unit, 5),
        log: []
      };
      save();
      render();
    });

    document.getElementById('gradeBtn').addEventListener('click', gradeAll);
    document.getElementById('print').addEventListener('click', () => window.print());
    document.getElementById('reset').addEventListener('click', () => {
      const ok = confirm('この学年・単元の保存データを消します。よろしいですか？');
      if (!ok) return;
      clearState();
      state = { meta:{ grade, unit, gradeLabel, unitLabel, createdAt: Date.now(), tags:[ `学年:${grade}`, `単元:${unitLabel}` ] }, problems: [], log: [] };
      render();
    });

    // ===== 離脱保護 =====
    window.addEventListener('beforeunload', (e) => {
      const hasUnanswered = state.problems.some(p => (p.userAnswer ?? '') === '');
      const saving = document.getElementById('saveStatus').textContent.includes('保存中');
      if (hasUnanswered || saving) { e.preventDefault(); e.returnValue = ''; }
    });
  </script>
</body>
</html> 
