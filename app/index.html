<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>出題フィルタ（学年/単元・計算種別・学年のみ＋除外）｜学びの森</title>
<style>
  body { font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif; background:#f8fafc; padding:24px; }
  .wrap { max-width: 1100px; margin:0 auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; }
  h1{ margin:0 0 12px; font-size:22px; }
  .muted{ color:#6b7280; font-size:13px; }
  .grid { display:grid; gap:16px; }
  .grid.cols-2 { grid-template-columns: 1fr 1fr; }
  .grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  fieldset{ border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
  legend{ padding:0 6px; color:#374151; }
  .row{ display:flex; flex-wrap:wrap; gap:10px 24px; }
  label.ck { display:inline-flex; align-items:center; gap:8px; margin:4px 0; }
  .chips{ display:flex; gap:6px; flex-wrap:wrap; }
  .chip{ font-size:12px; padding:2px 8px; border:1px solid #cbd5e1; border-radius:999px; background:#f8fafc; }
  .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 0; }
  .btn{ appearance:none; border:1px solid #cbd5e1; background:#fff; border-radius:8px; padding:10px 14px; }
  .btn.primary{ background:#2563eb; border-color:#2563eb; color:#fff; }
  input[type="number"]{ width:90px; padding:8px; border:1px solid #cbd5e1; border-radius:8px; }
  .box{ background:#f1f5f9; border-radius:8px; padding:10px; margin-top:12px; }
  .qrow{ padding:10px 0; border-bottom:1px dashed #e5e7eb; display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
  .qrow:last-child{ border-bottom:0; }
  input.answer{ width:160px; padding:8px; border:1px solid #cbd5e1; border-radius:8px; }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #cbd5e1; background:#fff; }
  .ok{ border-color:#16a34a; color:#166534; background:#ecfdf5; }
  .ng{ border-color:#dc2626; color:#991b1b; background:#fef2f2; }
</style>
</head>
<body>
<div class="wrap">
  <h1>出題フィルタ（学年/単元・計算種別・学年のみ＋除外）</h1>
  <p class="muted">※ <code>/app/problems.json</code> を読み込みます。Templates 側のカラム例：<code>id, grade, unit_label, operation, number_type, digit, carry, remainder, vars, template, answer_expr, answer_format</code></p>

  <fieldset>
    <legend>出題モード</legend>
    <div class="row">
      <label class="ck"><input type="radio" name="mode" value="gradeUnit" checked> 学年 × 単元で指定</label>
      <label class="ck"><input type="radio" name="mode" value="calcType"> 計算種別で指定（演算/数の型/桁/繰上・繰下/余り）</label>
      <label class="ck"><input type="radio" name="mode" value="gradeOnly"> 学年のみで指定</label>
    </div>
  </fieldset>

  <div id="panels" class="grid cols-3">
    <!-- パネルはJSで埋める -->
  </div>

  <div class="controls">
    <label>出題数 <input id="count" type="number" min="1" max="30" value="5"></label>
    <button id="gen" class="btn">候補から出題を作成</button>
    <button id="gradeBtn" class="btn primary">採点</button>
    <button id="printBtn" class="btn">PDFにする（印刷）</button>
    <button id="resetBtn" class="btn">回答リセット</button>
    <span id="status" class="muted">準備中</span>
  </div>

  <div id="summary" class="box"></div>
  <div id="problems" class="box"></div>
</div>

<script>
  // -------------- 汎用ユーティリティ --------------
  const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const uniq = arr => [...new Set(arr)];
  const by = (k) => (a,b)=> (a[k] > b[k] ? 1 : -1);

  // -------------- JSON読込み --------------
  let ALL = [];
  fetch('/app/problems.json').then(r=>r.json()).then(json=>{
    ALL = json;
    initUI();
    document.getElementById('status').textContent = `読み込み完了：テンプレ ${ALL.length} 件`;
  }).catch(e=>{
    document.getElementById('status').textContent = '読み込みエラー（problems.json を配置してください）';
    console.error(e);
  });

  // -------------- 変数サンプリング --------------
  function randInt(a,b){ return rnd(a,b); }
  function evalExpr(expr, env){
    const safe = expr.replace(/[a-zA-Z_][a-zA-Z0-9_]*/g, m => (m in env ? String(env[m]) : m));
    /* eslint-disable no-eval */
    return eval(safe);
  }
  function sampleEnv(spec, maxTry=100){
    // "a:3..5; b:2..6; c:a*b; ensure: (a%10+b%10)>=10"
    const parts = (spec||'').split(';').map(s=>s.trim()).filter(Boolean);
    for (let t=0;t<maxTry;t++){
      const env = {};
      // 範囲
      parts.forEach(p=>{
        const [k,v] = p.split(':').map(s=>s.trim());
        if (!k||!v) return;
        const m = v.match(/^(-?\d+)\.\.(-?\d+)$/);
        if (m) env[k] = randInt(Number(m[1]), Number(m[2]));
      });
      // 派生
      parts.forEach(p=>{
        const [k,v] = p.split(':').map(s=>s.trim());
        if (!k||!v) return;
        if (!/\.{2}/.test(v) && k!=='ensure'){
          env[k] = evalExpr(v, env);
        }
      });
      // ensure
      const en = parts.find(p=>p.startsWith('ensure'));
      if (en){
        const cond = en.split(':')[1].trim();
        if (!evalExpr(cond, env)) continue;
      }
      return env;
    }
    return null;
  }
  function fillTemplate(tpl, env){
    return tpl.replace(/{\s*([a-zA-Z_][a-zA-Z0-9_]*)\s*}/g, (_,k)=> env[k]);
  }

  // -------------- UI生成 --------------
  function initUI(){
    // 値の集合を抽出
    const grades = uniq(ALL.map(x=>String(x.grade))).sort();
    const units  = uniq(ALL.map(x=>x.unit_label || x.unit || '')).filter(Boolean).sort();
    const ops    = uniq(ALL.map(x=>x.operation||'').filter(Boolean)).sort();
    const numt   = uniq(ALL.map(x=>x.number_type||'').filter(Boolean)).sort();
    const digits = uniq(ALL.map(x=>x.digit||'').filter(Boolean)).sort();
    const carrys = uniq(ALL.map(x=>x.carry||'').filter(Boolean)).sort();
    const rems   = uniq(ALL.map(x=>x.remainder||'').filter(Boolean)).sort();

    const panels = document.getElementById('panels');
    panels.innerHTML = '';

    // 学年×単元（含める / 除外）
    panels.appendChild(panel(
      '学年（含む）','grade_inc', grades, true));
    panels.appendChild(panel(
      '単元（含む）','unit_inc', units, true));
    panels.appendChild(panel(
      '学年（除外）','grade_exc', grades, true));
    panels.appendChild(panel(
      '単元（除外）','unit_exc', units, true));

    // 計算種別（含める / 除外）
    panels.appendChild(panel('演算（含む）','op_inc', ops, true));
    panels.appendChild(panel('数の型（含む）','num_inc', numt, true));
    panels.appendChild(panel('桁（含む）','dig_inc', digits, true));
    panels.appendChild(panel('繰上/繰下（含む）','car_inc', carrys, true));
    panels.appendChild(panel('余り（含む）','rem_inc', rems, true));
    panels.appendChild(panel('演算（除外）','op_exc', ops, true));
    panels.appendChild(panel('数の型（除外）','num_exc', numt, true));
    panels.appendChild(panel('桁（除外）','dig_exc', digits, true));
    panels.appendChild(panel('繰上/繰下（除外）','car_exc', carrys, true));
    panels.appendChild(panel('余り（除外）','rem_exc', rems, true));

    // 学年のみ指定（含む/除外）→ 既存の grade_inc / grade_exc を使います

    document.getElementById('gen').addEventListener('click', generate);
    document.getElementById('gradeBtn').addEventListener('click', gradeAll);
    document.getElementById('printBtn').addEventListener('click', ()=>window.print());
    document.getElementById('resetBtn').addEventListener('click', resetAnswers);
  }

  function panel(title, key, values, compact=false){
    const fs = document.createElement('fieldset');
    const lg = document.createElement('legend'); lg.textContent = title; fs.appendChild(lg);
    const row = document.createElement('div'); row.className = 'row';
    values.forEach(v=>{
      const id = key+'__'+(v||'_');
      const lab = document.createElement('label'); lab.className='ck';
      lab.innerHTML = `<input type="checkbox" id="${id}" data-key="${key}" value="${v}"><span>${v||'(未設定)'}</span>`;
      row.appendChild(lab);
    });
    fs.appendChild(row);
    return fs;
  }

  function getMode(){
    return document.querySelector('input[name="mode"]:checked').value;
  }
  function getChecked(prefix){
    return [...document.querySelectorAll('input[type="checkbox"][data-key^="'+prefix+'"]:checked')].map(el=>el.value);
  }

  // -------------- 出題生成 --------------
  let CURRENT = []; // {id, text, answer, meta, userAnswer, result}
  function generate(){
    const mode = getMode();
    const count = Math.max(1, Math.min(30, Number(document.getElementById('count').value)||5));

    // 収集：include / exclude
    const Ginc = getChecked('grade_inc');
    const Gexc = getChecked('grade_exc');
    const Uinc = getChecked('unit_inc');
    const Uexc = getChecked('unit_exc');

    const Oinc = getChecked('op_inc');
    const Oexc = getChecked('op_exc');
    const Ninc = getChecked('num_inc');
    const Nexc = getChecked('num_exc');
    const Dinc = getChecked('dig_inc');
    const Dexc = getChecked('dig_exc');
    const Cinc = getChecked('car_inc');
    const Cexc = getChecked('car_exc');
    const Rinc = getChecked('rem_inc');
    const Rexc = getChecked('rem_exc');

    // フィルタ関数
    const pass = (t) => {
      // 除外（先適用）
      if (Gexc.length && Gexc.includes(String(t.grade))) return false;
      if (Uexc.length && Uexc.includes(t.unit_label || t.unit || '')) return false;
      if (Oexc.length && Oexc.includes(t.operation||'')) return false;
      if (Nexc.length && Nexc.includes(t.number_type||'')) return false;
      if (Dexc.length && Dexc.includes(t.digit||'')) return false;
      if (Cexc.length && Cexc.includes(t.carry||'')) return false;
      if (Rexc.length && Rexc.includes(t.remainder||'')) return false;

      if (mode==='gradeUnit'){
        if (Ginc.length && !Ginc.includes(String(t.grade))) return false;
        if (Uinc.length && !(Uinc.includes(t.unit_label||t.unit||''))) return false;
        return true;
      }
      if (mode==='calcType'){
        // 各カテゴリは「選んでいればAND」「未選択なら無視」
        if (Oinc.length && !Oinc.includes(t.operation||'')) return false;
        if (Ninc.length && !Ninc.includes(t.number_type||'')) return false;
        if (Dinc.length && !Dinc.includes(t.digit||'')) return false;
        if (Cinc.length && !Cinc.includes(t.carry||'')) return false;
        if (Rinc.length && !Rinc.includes(t.remainder||'')) return false;
        // 学年は任意だが、除外のみ適用済
        if (Ginc.length && !Ginc.includes(String(t.grade))) return false;
        return true;
      }
      if (mode==='gradeOnly'){
        if (Ginc.length && !Ginc.includes(String(t.grade))) return false;
        return true;
      }
      return true;
    };

    const candidates = ALL.filter(pass);
    if (!candidates.length){
      document.getElementById('summary').innerHTML = `<span class="muted">条件に合うテンプレがありません（フィルタを緩めてください）</span>`;
      document.getElementById('problems').innerHTML = '';
      CURRENT = [];
      return;
    }

    // ランダムピック＋インスタンス化
    const chosen = [];
    for (let i=0;i<count;i++){
      const t = candidates[rnd(0, candidates.length-1)];
      const env = sampleEnv(t.vars);
      if (!env){ i--; continue; } // 生成失敗時は引き直し
      const text = fillTemplate(t.template, env);
      const ansRaw = evalExpr(t.answer_expr, env);
      const ans = (t.answer_format||'integer').startsWith('decimal')
        ? String(ansRaw) : String(ansRaw); // 簡略（詳細フォーマットは今後拡張）
      chosen.push({
        id: `${t.id}-${Date.now()}-${i}`,
        qid: t.id,
        text, answer: ans,
        meta: {
          grade: t.grade,
          unit: t.unit_label||t.unit||'',
          operation: t.operation||'',
          number_type: t.number_type||'',
          digit: t.digit||'',
          carry: t.carry||'',
          remainder: t.remainder||'',
          vars: env
        },
        userAnswer: '', result: null
      });
    }
    CURRENT = chosen;
    renderProblems();
    document.getElementById('summary').innerHTML =
      `<div class="chips">
        <span class="chip">候補 ${candidates.length} 件</span>
        <span class="chip">出題 ${CURRENT.length} 問</span>
        <span class="chip">モード: ${({gradeUnit:'学年×単元',calcType:'計算種別',gradeOnly:'学年のみ'})[mode]}</span>
      </div>`;
  }

  // -------------- 描画・採点 --------------
  function renderProblems(){
    const box = document.getElementById('problems');
    if (!CURRENT.length){ box.innerHTML = `<span class="muted">出題を作成するとここに表示されます。</span>`; return; }
    box.innerHTML = CURRENT.map((q,idx)=>{
      const pill = q.result===true ? '<span class="pill ok">○ 正解</span>'
                 : q.result===false ? '<span class="pill ng">× 不正解</span>'
                 : '<span class="pill">未採点</span>';
      return `
        <div class="qrow" data-id="${q.id}">
          <div>
            <div><strong>Q${idx+1}.</strong> ${q.text}</div>
            <div class="muted">[${q.meta.grade}年] ${q.meta.unit}｜${q.meta.operation}/${q.meta.number_type}/${q.meta.digit}/${q.meta.carry}/${q.meta.remainder}</div>
          </div>
          <div>
            <input class="answer" placeholder="答え" value="${q.userAnswer}">
            <div style="text-align:right;margin-top:6px;">${pill}</div>
          </div>
        </div>
      `;
    }).join('');
    // 入力ハンドラ
    box.querySelectorAll('input.answer').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const id = e.target.closest('.qrow').getAttribute('data-id');
        const item = CURRENT.find(x=>x.id===id);
        if (item){ item.userAnswer = e.target.value.trim(); }
      });
    });
  }

  function gradeAll(){
    let ok=0;
    CURRENT.forEach(q=>{
      const ua = (q.userAnswer||'').trim();
      q.result = (ua!=='' && ua==q.answer);
      if (q.result) ok++;
    });
    renderProblems();
    alert(`採点：${ok} / ${CURRENT.length} 正解`);
  }

  function resetAnswers(){
    CURRENT.forEach(q=>{ q.userAnswer=''; q.result=null; });
    renderProblems();
  }
</script>
</body>
</html>
