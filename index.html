<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>学びの森ドリル（仮）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="学年・単元・計算種別から最適な文章題をランダム生成" />
  <style>
    :root{
      --brand:#2563eb;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --bg:#f8fafc;
      --card:#ffffff;
      --accent:#f1f5f9;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "ヒラギノ角ゴ ProN", "Hiragino Kaku Gothic ProN", "メイリオ", Meiryo, sans-serif;
      color:var(--ink);
      background:var(--bg);
      margin:0;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{padding:24px 0 8px}
    h1{font-size:clamp(22px,3.6vw,32px);margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 20px}
    .cta{display:flex;gap:10px;margin:16px 0 28px;flex-wrap:wrap}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.outline{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .panel{
      background:var(--card);border:1px solid var(--line);border-radius:14px;
      padding:14px 14px 10px;margin:14px 0;
      box-shadow: 0 1px 0 rgba(15,23,42,.02);
    }
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label.ck{display:inline-flex;gap:8px;align-items:center}
    label.ck span{white-space:nowrap}

    /* --- フォーム群 --- */
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}
    input[type="number"]{width:80px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
    .small{font-size:12px;color:var(--muted)}

    /* --- fieldset / legend（文字切れ対策 & 内枠点線） --- */
    fieldset{
      min-width:0;border:1px dashed var(--line);border-radius:12px;padding:12px 12px 10px;margin:0;
      background:#fff;
    }
    legend{
      padding:2px 8px; line-height:1.3;          /* ← 文字の上欠け防止 */
      background:var(--accent); border:1px solid var(--line);
      border-radius:999px; font-weight:700; color:#0b1324;
    }
    .fs-grid{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:10px}
    .fs-row{display:flex;flex-wrap:wrap;gap:12px;margin-top:6px}

    /* --- 計算種別 UI（縦→横の2カラム） --- */
    .calc-layout{display:grid;grid-template-columns:220px 1fr;gap:12px;margin-top:6px}
    @media (max-width:720px){ .calc-layout{grid-template-columns:1fr} }
    .ops-list{display:grid;grid-auto-rows:minmax(56px,auto);gap:10px}
    .op-item{
      border:1px solid var(--line);border-radius:12px;background:#fff;
      display:flex;align-items:center;transition:box-shadow .15s, border-color .15s;
      min-height:44px;
    }
    .op-item.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .op-item .label-wrap{display:flex;align-items:center;gap:10px;padding:10px 12px;width:100%}
    .details{
      border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px;min-height:56px
    }
    .details h3{margin:2px 0 10px;line-height:1.25}

    /* 左のアクティブブロックを右の高さに合わせて伸ばす */
    .ops-list .op-item.active.match-height{align-items:stretch}

    /* 問題表示 */
    #problems .q{border-bottom:1px solid var(--line);padding:10px 2px}
    .answer{width:140px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}

    footer{color:var(--muted);font-size:12px;margin:32px 0 16px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>本当に学力がつくドリル。</h1>
      <p class="sub">学年・単元・計算種別から最適な<ruby>文章題<rt>ぶんしょうだい</rt></ruby>を毎回ランダム生成。将来的には正誤履歴で出題を自動調整します。</p>
      <div class="cta">
        <button class="btn" onclick="document.getElementById('mode-sec').scrollIntoView({behavior:'smooth'})">条件を選んで出題</button>
        <button class="btn outline" onclick="alert('従来UIは準備中です')">従来UI</button>
      </div>
    </header>

    <!-- 出題条件 -->
    <section id="mode-sec" class="panel">
      <h2 style="margin:4px 0 10px;font-size:18px">出題条件の選択</h2>
      <p class="small">読み込み中…（<code>/app/problems.json</code> を参照）</p>

      <fieldset class="panel" style="padding:12px">
        <legend>出題モード</legend>
        <div class="row" style="margin:6px 0 2px">
          <label class="ck"><input type="radio" name="mode" value="grade-unit"> <span>学年 × 単元で指定</span></label>
          <label class="ck"><input type="radio" name="mode" value="calc" checked> <span>計算種別で指定</span></label>
          <label class="ck"><input type="radio" name="mode" value="grade-only"> <span>学年のみで指定</span></label>
        </div>
        <div id="mode-box" style="margin-top:10px"></div>

        <div class="controls">
          <label>出題数 <input type="number" id="n" value="5" min="1" max="20"></label>
          <button class="btn outline" onclick="createFromFilters()">候補から出題を作成</button>
          <button class="btn" onclick="renderProblems()">提示</button>
          <button class="btn outline" onclick="window.print()">PDFにする（印刷）</button>
          <button class="btn outline" onclick="resetAnswers()">回答リセット</button>
        </div>
      </fieldset>
    </section>

    <!-- 問題の表示 -->
    <section id="problems" class="panel"></section>

    <section class="panel">
      <h3 style="margin:0 0 6px">しくみ</h3>
      <p class="small">テンプレ（Templates）で文章問題を設計し、変数をランダム展開。出題条件でフィルタしながらユニークな問題を生成します。将来は正誤履歴と紐づけて最適化予定。</p>
    </section>

    <footer>© 学びの森</footer>
  </div>

  <script>
    /* =====================
       設定データ & ヘルパー
    ======================*/
    const VALUES = {
      grades: ['2','3','4'],               // 表示用の学年（必要に応じて増減）
      ops: ['加法','減法','乗法','除法']
    };

    // チェックボックス群を持つ fieldset を生成
    function fieldset(title, name, options){
      const fs = document.createElement('fieldset');
      const lg = document.createElement('legend'); lg.textContent = title;
      const row = document.createElement('div'); row.className = 'fs-row';
      options.forEach((label,i)=>{
        const id = `${name}_${i}`;
        const lab = document.createElement('label'); lab.className = 'ck';
        lab.innerHTML = `<input type="checkbox" name="${name}" value="${label}"> <span>${label}</span>`;
        row.appendChild(lab);
      });
      fs.append(lg,row);
      return fs;
    }

    // グリッド用のラッパ
    function grid(...fss){
      const g = document.createElement('div'); g.className='fs-grid';
      fss.forEach(x=>g.appendChild(x));
      return g;
    }

    /* =====================
       出題モードの描画
    ======================*/

    // 1) 計算種別：左右2カラム + 高さ同期版
    function renderCalcSubPanels(container){
      container.innerHTML = '';

      const wrap  = document.createElement('div');
      wrap.className = 'calc-layout';

      const left  = document.createElement('div');
      left.className = 'ops-list';

      const right = document.createElement('div');
      right.className = 'details';
      right.innerHTML = '<div class="muted">左の計算を選ぶと、細かな条件が表示されます。</div>';

      wrap.append(left, right);
      container.appendChild(wrap);

      // 右側の中身ビルダー
      const builders = {
        '加法': g => {
          g.appendChild(fieldset('桁','add_dig',['1桁','2桁','3桁']));
          g.appendChild(fieldset('繰り上がり','add_carry',['繰り上がりあり','なし','不問']));
        },
        '減法': g => {
          g.appendChild(fieldset('桁','sub_dig',['1桁','2桁','3桁']));
          g.appendChild(fieldset('繰下がり','sub_borrow',['繰下がりあり','なし','不問']));
        },
        '乗法': g => {
          g.appendChild(fieldset('形式','mul_form',['1桁×1桁','2桁×1桁','2桁×2桁']));
          g.appendChild(fieldset('繰り上がり','mul_carry',['繰り上がりあり','なし','不問']));
        },
        '除法': g => {
          g.appendChild(fieldset('形式','div_form',['2桁÷1桁','3桁÷1桁','2桁÷2桁']));
          g.appendChild(fieldset('余り','div_rem',['あり','なし','不問']));
        }
      };

      function renderRight(opName){
        right.innerHTML = '';
        const h   = document.createElement('h3');
        h.textContent = `${opName} の条件`;

        const gridBox = document.createElement('div'); gridBox.className='fs-grid';
        builders[opName](gridBox);
        gridBox.appendChild(fieldset('学年（任意で制約）','grade_inc',VALUES.grades));
        gridBox.appendChild(fieldset('学年（除外）','grade_exc',VALUES.grades));

        right.append(h, gridBox);

        requestAnimationFrame(matchActiveHeight);
      }

      function makeLeftItem(name){
        const row  = document.createElement('div');
        row.className = 'op-item';
        row.innerHTML = `<div class="label-wrap">
           <input type="checkbox" data-key="op_sel" value="${name}">
           <span>${name}</span>
         </div>`;
        const input = row.querySelector('input');

        // チェックはフィルタ用・ラベルクリックは右の表示切替
        row.addEventListener('click',(e)=>{
          if(e.target === input){ row.classList.toggle('active', input.checked); return; }
          renderRight(name);
          document.querySelectorAll('.ops-list .op-item').forEach(el=>el.classList.remove('active'));
          row.classList.add('active');
        });
        return row;
      }

      VALUES.ops.forEach(name => left.appendChild(makeLeftItem(name)));

      // 初期表示：加法
      const first = left.firstElementChild;
      first.classList.add('active');
      renderRight('加法');

      // 右の高さに合わせて左の active を伸ばす
      function matchActiveHeight(){
        const active = document.querySelector('.ops-list .op-item.active');
        if(!active) return;
        active.style.minHeight = '';
        active.classList.add('match-height');
        const h = right.getBoundingClientRect().height;
        active.style.minHeight = `${Math.max(56, h)}px`;
      }
      right.addEventListener('change', ()=>requestAnimationFrame(matchActiveHeight));
      window.addEventListener('resize', ()=>requestAnimationFrame(matchActiveHeight));
    }

    // 2) 学年×単元（プレースホルダ）
    function renderGradeUnitPanels(container){
      container.innerHTML = '';
      const g = grid(
        fieldset('学年','gu_grade',VALUES.grades),
        fieldset('単元（例）','gu_unit',['小数','分数','図形','割合'])
      );
      container.appendChild(g);
    }

    // 3) 学年のみ（プレースホルダ）
    function renderGradeOnlyPanels(container){
      container.innerHTML = '';
      container.appendChild(fieldset('学年を選択','go_grade',VALUES.grades));
    }

    // モード切替のハブ
    function renderModeUI(){
      const mode = document.querySelector('input[name="mode"]:checked')?.value;
      const box  = document.getElementById('mode-box');
      if(!box) return;
      box.innerHTML = '';

      try{
        if(mode === 'calc'){ renderCalcSubPanels(box); return; }
        if(mode === 'grade-unit'){ renderGradeUnitPanels(box); return; }
        if(mode === 'grade-only'){ renderGradeOnlyPanels(box); return; }
      }catch(err){
        console.error('[renderModeUI] failed:', err);
        box.innerHTML = `<div class="muted">描画中にエラーが発生しました。コンソールを確認してください。</div>`;
      }
    }

    // ラジオ連動 & 初期描画
    document.querySelectorAll('input[name="mode"]').forEach(r =>
      r.addEventListener('change', renderModeUI)
    );
    renderModeUI();

    /* =====================
       仮の問題生成・表示
       （本番ではテンプレ + 乱数展開 + フィルタ）
    ======================*/
    const CURRENT = []; // 表示中の問題（簡易）

    function createFromFilters(){
      // ここではダミーの文章を作るだけ
      CURRENT.length = 0;
      const n = Math.max(1, Math.min(20, Number(document.getElementById('n').value||5)));
      for(let i=0;i<n;i++){
        CURRENT.push({ q:`Q${i+1}. りんごを ${2+i} 個ずつ袋に入れます。全部でいくつになりますか？`, answer:null, ok:null });
      }
      renderProblems();
    }

    function renderProblems(){
      const box = document.getElementById('problems');
      if(!CURRENT.length){ box.innerHTML = '<div class="muted">まだ問題がありません。「候補から出題を作成」を押してください。</div>'; return; }
      box.innerHTML = CURRENT.map((it,idx)=>`
        <div class="q">
          <div><strong>${it.q}</strong></div>
          <div class="row" style="margin-top:6px">
            <input class="answer" placeholder="こたえ" data-idx="${idx}">
            <button class="btn outline small" onclick="gradeOne(${idx})">判定</button>
            <span id="r${idx}" class="small muted"></span>
          </div>
        </div>
      `).join('');
      // 入力→Enterで判定
      box.querySelectorAll('.answer').forEach(inp=>{
        inp.addEventListener('keydown',e=>{ if(e.key==='Enter') gradeOne(Number(inp.dataset.idx)); });
      });
    }

    function gradeOne(i){
      const inp = document.querySelector(`.answer[data-idx="${i}"]`);
      if(!inp) return;
      const val = String(inp.value||'').trim();
      CURRENT[i].answer = val;
      const ok = Math.random()>.5;              // 仮：ランダムで正誤
      CURRENT[i].ok = ok;
      document.getElementById('r'+i).textContent = ok ? '◯ 正解！' : '× もう一度';
      document.getElementById('r'+i).style.color = ok ? '#16a34a' : '#dc2626';
      // TODO: localStorage 等に一時保存（将来の履歴用）
    }

    function resetAnswers(){
      CURRENT.forEach(it=>{ it.answer=null; it.ok=null; });
      renderProblems();
      alert('回答をリセットしました');
    }
  </script>
</body>
</html>
