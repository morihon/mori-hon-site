<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>学びの森ドリル（仮）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{--brand:#2563eb;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--bg:#f8fafc;--card:#fff;--accent:#f1f5f9}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;background:var(--bg);color:var(--ink);margin:0}
.wrap{max-width:980px;margin:0 auto;padding:16px}
h1{margin:18px 0 8px;font-size:clamp(22px,3.6vw,32px)}
.sub{color:var(--muted);margin:0 0 16px}
.btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.outline{background:#fff;color:var(--brand);border:1px solid var(--brand)}
.panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:14px 0}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* 共通フィールドセット */
fieldset{min-width:0;border:1px dashed var(--line);border-radius:12px;padding:12px;background:#fff}
legend{padding:2px 8px;background:var(--accent);border:1px solid var(--line);border-radius:999px;font-weight:700}
.fs-grid{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:10px}
.fs-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
label.ck{display:inline-flex;gap:8px;align-items:center}
label.ck span{white-space:nowrap}

/* 新：計算ごとの縦並びレイアウト */
.calc-rows{display:flex;flex-direction:column;gap:10px;margin-top:8px}
.calc-row{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:start}
@media (max-width:720px){ .calc-row{grid-template-columns:1fr} }
.op-box{border:1px solid var(--line);border-radius:12px;background:#fff;min-height:48px;display:flex;align-items:center}
.op-box .wrap{padding:10px 12px;display:flex;gap:10px;align-items:center}
.op-box.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
.detail-box{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px;display:none}
.detail-box.show{display:block}
.detail-card{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px}
.detail-card h3{margin:2px 0 10px}

/* 入力 */
input[type="number"]{width:80px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}

/* 問題表示 */
#problems .q{border-bottom:1px solid var(--line);padding:10px 2px}
.answer{width:140px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>本当に学力がつくドリル。</h1>
  <p class="sub">学年・単元・計算種別から最適な文章題をランダム生成。将来は正誤履歴で自動調整します。</p>

  <section id="mode-sec" class="panel">
    <h2 style="margin:4px 0 10px;font-size:18px">出題条件の選択</h2>
    <p class="small">読み込み中…（/app/problems.json を参照）</p>

    <fieldset class="panel" style="padding:12px">
      <legend>出題モード</legend>
      <div class="row" style="margin:6px 0 2px">
        <label class="ck"><input type="radio" name="mode" value="grade-unit"> <span>学年 × 単元で指定</span></label>
        <label class="ck"><input type="radio" name="mode" value="calc" checked> <span>計算種別で指定</span></label>
        <label class="ck"><input type="radio" name="mode" value="grade-only"> <span>学年のみで指定</span></label>
      </div>
      <div id="mode-box" style="margin-top:10px"></div>

      <div class="row" style="margin-top:12px">
        <label>出題数 <input type="number" id="n" value="5" min="1" max="20"></label>
        <button class="btn outline" onclick="createFromFilters()">候補から出題を作成</button>
        <button class="btn" onclick="renderProblems()">提示</button>
        <button class="btn outline" onclick="window.print()">PDFにする（印刷）</button>
        <button class="btn outline" onclick="resetAnswers()">回答リセット</button>
      </div>
    </fieldset>
  </section>

  <section id="problems" class="panel"></section>

  <section class="panel">
    <h3 style="margin:0 0 6px">しくみ</h3>
    <p class="small">テンプレ（Templates）で文章問題を設計し、変数をランダム展開。出題条件でフィルタしながらユニークな問題を生成。将来は正誤履歴と紐づけて最適化予定。</p>
  </section>
</div>

<script>
/* 設定 */
const VALUES = { grades:['2','3','4'], ops:['加法','減法','乗法','除法'] };

/* 小物 */
function fieldset(title, name, opts){
  const fs = document.createElement('fieldset');
  const lg = document.createElement('legend'); lg.textContent = title;
  const row = document.createElement('div'); row.className='fs-row';
  opts.forEach(v=>{
    const lab=document.createElement('label'); lab.className='ck';
    lab.innerHTML = `<input type="checkbox" name="${name}" value="${v}"> <span>${v}</span>`;
    row.appendChild(lab);
  });
  fs.append(lg,row); return fs;
}
function fsGrid(...nodes){ const g=document.createElement('div'); g.className='fs-grid'; nodes.forEach(n=>g.appendChild(n)); return g; }

/* --- モード描画 --- */
function renderModeUI(){
  const mode = document.querySelector('input[name="mode"]:checked')?.value;
  const box  = document.getElementById('mode-box'); box.innerHTML='';
  if(mode==='calc'){ renderCalcRows(box); return; }
  if(mode==='grade-unit'){ box.append(fsGrid(fieldset('学年','gu_grade',VALUES.grades),fieldset('単元（例）','gu_unit',['小数','分数','図形','割合']))); return; }
  if(mode==='grade-only'){ box.append(fieldset('学年を選択','go_grade',VALUES.grades)); return; }
}
document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change',renderModeUI));

/* 新：計算ごとの行（左：計算／右：詳細） */
function renderCalcRows(container){
  const rows = document.createElement('div'); rows.className='calc-rows';
  container.appendChild(rows);

  const builders = {
    '加法':()=>detailCard('加法 の条件', fsGrid(
      fieldset('桁','add_dig',['1桁','2桁','3桁']),
      fieldset('繰り上がり','add_carry',['繰り上がりあり','なし','不問']),
      fieldset('学年（任意で制約）','add_gi',VALUES.grades),
      fieldset('学年（除外）','add_ge',VALUES.grades)
    )),
    '減法':()=>detailCard('減法 の条件', fsGrid(
      fieldset('桁','sub_dig',['1桁','2桁','3桁']),
      fieldset('繰下がり','sub_borrow',['繰下がりあり','なし','不問']),
      fieldset('学年（任意で制約）','sub_gi',VALUES.grades),
      fieldset('学年（除外）','sub_ge',VALUES.grades)
    )),
    '乗法':()=>detailCard('乗法 の条件', fsGrid(
      fieldset('形式','mul_form',['1桁×1桁','2桁×1桁','2桁×2桁']),
      fieldset('繰り上がり','mul_carry',['繰り上がりあり','なし','不問']),
      fieldset('学年（任意で制約）','mul_gi',VALUES.grades),
      fieldset('学年（除外）','mul_ge',VALUES.grades)
    )),
    '除法':()=>detailCard('除法 の条件', fsGrid(
      fieldset('形式','div_form',['2桁÷1桁','3桁÷1桁','2桁÷2桁']),
      fieldset('余り','div_rem',['あり','なし','不問']),
      fieldset('学年（任意で制約）','div_gi',VALUES.grades),
      fieldset('学年（除外）','div_ge',VALUES.grades)
    ))
  };

  VALUES.ops.forEach(op=>{
    const row = document.createElement('div'); row.className='calc-row'; row.dataset.op=op;
    const left = document.createElement('div'); left.className='op-box';
    left.innerHTML = `<div class="wrap"><input type="checkbox" value="${op}"> <strong>${op}</strong></div>`;
    const right = document.createElement('div'); right.className='detail-box'; // hidden initially
    row.append(left,right); rows.appendChild(row);

    const input = left.querySelector('input');
    input.addEventListener('change', ()=>{
      if(input.checked){
        left.classList.add('active');
        // 初回だけ生成
        if(!right.firstChild){ right.appendChild(builders[op]()); }
        right.classList.add('show');
        syncHeight(row);
      }else{
        left.classList.remove('active');
        right.classList.remove('show');
        row.style.minHeight = '48px';
      }
    });

    // 右側の内容が変わったら高さ再同期
    right.addEventListener('change', ()=>syncHeight(row));
    window.addEventListener('resize', ()=>syncHeight(row));
  });
}

function detailCard(title, inner){
  const card = document.createElement('div'); card.className='detail-card';
  const h = document.createElement('h3'); h.textContent=title;
  card.append(h, inner); return card;
}

function syncHeight(row){
  // 右が見えている時だけ高さを合わせる
  const right = row.querySelector('.detail-box');
  if(right && right.classList.contains('show')){
    const h = Math.max(56, right.getBoundingClientRect().height);
    row.style.minHeight = h + 'px';
  }
}

/* 仮の出題/判定 */
const CURRENT=[];
function createFromFilters(){
  CURRENT.length=0;
  const n=Math.max(1,Math.min(20,Number(document.getElementById('n').value||5)));
  for(let i=0;i<n;i++){
    CURRENT.push({q:`Q${i+1}. りんごを ${2+i} 個ずつ袋に入れます。全部でいくつ？`,answer:null,ok:null});
  }
  renderProblems();
}
function renderProblems(){
  const box=document.getElementById('problems');
  if(!CURRENT.length){ box.innerHTML='<div class="small">まだ問題がありません。「候補から出題を作成」を押してください。</div>'; return; }
  box.innerHTML=CURRENT.map((it,i)=>`
    <div class="q">
      <div><strong>${it.q}</strong></div>
      <div class="row" style="margin-top:6px">
        <input class="answer" placeholder="こたえ" data-i="${i}">
        <button class="btn outline" onclick="gradeOne(${i})" style="padding:6px 10px">判定</button>
        <span id="r${i}" class="small"></span>
      </div>
    </div>`).join('');
  box.querySelectorAll('.answer').forEach(inp=>{
    inp.addEventListener('keydown',e=>{ if(e.key==='Enter') gradeOne(Number(inp.dataset.i)); });
  });
}
function gradeOne(i){
  const ok=Math.random()>.5; CURRENT[i].ok=ok;
  const el=document.getElementById('r'+i); el.textContent= ok?'◯ 正解！':'× もう一度'; el.style.color= ok?'#16a34a':'#dc2626';
}
function resetAnswers(){ CURRENT.forEach(x=>x.answer=null,x=>x.ok=null); renderProblems(); alert('回答をリセットしました'); }

/* 初期描画 */
renderModeUI();
</script>
</body>
</html>
